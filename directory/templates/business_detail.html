{% extends "base.html" %}
{% load static %}

{% block title %}{{ b.name }} | ouray.info{% endblock %}
{% block body_class %}detail{% endblock %}

{% block extra_head %}
  <link rel="preload" as="image" href="{% static 'directory/img/abrams-image.jpg' %}">
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
{% endblock %}

{% block content %}
<nav class="topnav" aria-label="Categories">
  <div class="container topnav-inner">
    <a class="topnav-link" href="{% url 'home' %}#coffee">Coffee</a>
    <a class="topnav-link" href="{% url 'home' %}#restaurants">Restaurants</a>
    <a class="topnav-link" href="{% url 'home' %}#shopping">Shopping</a>
    <a class="topnav-link" href="{% url 'home' %}#other">Other</a>
  </div>
</nav>

<section class="detail-hero" style="--band-image: url('{% if b.hero_image %}{{ b.hero_image.url }}{% else %}{% static "directory/img/abrams-image.jpg" %}{% endif %}');">
  <div class="detail-overlay"></div>

  <div class="container detail-shell">
    <p class="backlink"><a href="{% url 'home' %}">← Back to directory</a></p>

    <header class="detail-header">
      <div class="detail-brand">
        <div>
          <h1 class="detail-title">{{ b.name }}</h1>
          {% if b.category %}<div class="detail-sub"><span class="pill">{{ b.category }}</span></div>{% endif %}
          <div class="detail-rating">
            {% if review_count %}
              <div class="rating-row">
                <span class="rating-label">Ouray.info</span>
                <span class="rating-count">{{ review_count }} reviews</span>
                <span class="star-bar" style="--fill-percent: {{ ouray_fill_percent }}%;"></span>
                <span class="rating-score">{{ avg_rating|floatformat:2 }}</span>
              </div>
            {% else %}
              <div class="rating-row">
                <span class="rating-count">No reviews yet</span>
              </div>
            {% endif %}

            {% if google_rating %}
              <div class="rating-row">
                <span class="rating-label">Google</span>
                <span class="rating-count">{{ google_user_count }} reviews</span>
                <span class="star-bar" style="--fill-percent: {{ google_fill_percent }}%;"></span>
                <span class="rating-score">{{ google_rating|floatformat:2 }}</span>
                {% if google_maps_uri %}
                  <a class="rating-link" href="{{ google_maps_uri }}" target="_blank" rel="noopener">Read on Google</a>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="detail-side">
        {% if b.logo_image %}
          <img class="detail-logo detail-logo--top" src="{{ b.logo_image.url }}" alt="{{ b.name }} logo">
        {% endif %}

        <div class="detail-cta">
          {% if b.website %}
            <a class="btn" href="{{ b.website }}" target="_blank" rel="noopener">Visit website</a>
          {% endif %}
          <form method="post" action="{% url 'bookmark_toggle' b.slug %}">
            {% csrf_token %}
            <button class="btn btn-ghost" type="submit">
              {% if is_bookmarked %}Bookmarked{% else %}Bookmark{% endif %}
            </button>
          </form>
        </div>
      </div>
    </header>

    <div class="detail-body">
      {% if b.description %}
        <p class="detail-desc">{{ b.description }}</p>
      {% else %}
        <p class="detail-desc detail-desc--muted">No description yet.</p>
      {% endif %}

      <div class="detail-meta-grid">
        {% if b.address %}
          <div class="meta-row"><span class="meta-label">Address</span><span class="meta-value">{{ b.address }}</span></div>
        {% endif %}
        {% if b.phone %}
          <div class="meta-row"><span class="meta-label">Phone</span><span class="meta-value">{{ b.phone }}</span></div>
        {% endif %}
        {% if b.website %}
          <div class="meta-row">
            <span class="meta-label">Website</span>
            <span class="meta-value"><a href="{{ b.website }}" target="_blank" rel="noopener">{{ b.website }}</a></span>
          </div>
        {% endif %}
      </div>

      <div class="detail-actions">
        <a class="btn btn-ghost" href="{% url 'home' %}">Back</a>
      </div>

      <div class="review-block">
        <h2 class="review-title">Reviews</h2>

        <div class="review-list">
          {% for r in combined_reviews %}
            <article class="review-card">
              <div class="review-head">
                <span class="review-stars">{{ r.rating }}/5</span>
                <span class="review-source">
                  {% if r.source == "google" %}Google{% else %}Ouray.info{% endif %}
                </span>
                <span class="review-date">
                  {% if r.source == "google" %}
                    {{ r.date }}
                  {% else %}
                    {{ r.date|date:"M j, Y" }}
                  {% endif %}
                </span>
              </div>
              {% if r.name %}<div class="review-name">{{ r.name }}</div>{% endif %}
              <p class="review-comment">{{ r.comment }}</p>
              {% if r.source == "google" and r.google_maps_uri %}
                <a class="review-link" href="{{ r.google_maps_uri }}" target="_blank" rel="noopener">Read on Google</a>
              {% endif %}
            </article>
          {% empty %}
            <p class="detail-desc detail-desc--muted">No reviews yet.</p>
          {% endfor %}
        </div>

        {% if google_rating %}
          <p class="review-attrib">Powered by Google</p>
        {% endif %}


        <div class="review-form-wrap">
          <h3 class="review-subtitle">Add a review</h3>
          {% if review_error %}
            <p class="band-meta">{{ review_error }}</p>
          {% endif %}
          <form method="post" class="card contact-form" action="{% url 'review_submit' b.slug %}">
            {% csrf_token %}
            <div class="detail-meta-grid">
              <label class="meta-row">
                <span class="meta-label">Rating</span>
                <select class="meta-value" name="rating" required>
                  <option value="">Select…</option>
                  {% for v in "12345" %}
                    <option value="{{ v }}" {% if review_form.rating == v %}selected{% endif %}>{{ v }}</option>
                  {% endfor %}
                </select>
              </label>
              <label class="meta-row">
                <span class="meta-label">Name (optional)</span>
                <input class="meta-value" type="text" name="name" value="{{ review_form.name|default_if_none:'' }}">
              </label>
              <label class="meta-row">
                <span class="meta-label">Email (optional)</span>
                <input class="meta-value" type="email" name="email" value="{{ review_form.email|default_if_none:'' }}">
              </label>
              <label class="meta-row">
                <span class="meta-label">Comment</span>
                <textarea class="meta-value" name="comment" rows="4" maxlength="1000" required>{{ review_form.comment|default_if_none:'' }}</textarea>
              </label>
            </div>

            <div style="margin-top: 16px;">
              <div class="g-recaptcha" data-sitekey="{{ site_key }}"></div>
            </div>

            <div class="detail-actions" style="margin-top: 16px;">
              <button class="btn" type="submit">Submit review</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}
